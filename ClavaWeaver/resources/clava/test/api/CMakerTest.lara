import lara.Io;
import lara.cmake.CMaker;
import clava.Clava;

aspectdef CMakerTest

	var cmaker = new CMaker("testapp")
		.setMinimumVersion("3.0.2")
		.setMakeCommand("mingw32-make")
		.addCxxFlags("-O3", "-std=c++11")
		.addLibs("stdc++");

	var outputFolder = "cmakerTestSrc/";


	select file end
	apply
	
		//var sourceFile = Io.getPath(Clava.getWeavingFolder(), $file.relativeFilepath);
		//cmaker.sources.addSource(sourceFile);
		cmaker.sources.addSource($file.relativeFilepath);

		
		if($file.isHeader) {
			//var headerFolder = Io.getPath(Clava.getWeavingFolder(), $file.relativeFolderpath);
			//cmaker.addIncludeFolder(headerFolder);
			cmaker.addIncludeFolder($file.relativeFolderpath);
		}
	end

	// Writing the build file
	//var cmakeFile = Io.getPath(Clava.getWeavingFolder(), "CMakeLists.txt");
	//Io.writeFile(cmakeFile, cmaker.getCode());
	
	// Write code
	Clava.writeCode(Clava.getWeavingFolder());
	
	// Build
	var buildFolder = Io.getPath(Clava.getWeavingFolder(), "build");
	var executable = cmaker.build(Clava.getWeavingFolder(), buildFolder, '-G "MinGW Makefiles"');

	println("Created executable: " + executable);
end
